<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blanco gusmar | Pagos</title>
  <%- include("../partials/links/normalize-fa-nav.styles.ejs") %>
  <link rel="stylesheet" href="/pagos/css/pagos.cte.css">
  <link rel="stylesheet" href="/css/navigation/buscador.css">
  <script src="https://kit.fontawesome.com/b03be97bbd.js" crossorigin="anonymous"></script>
</head>
<% const meses = ["ANT","ENE","FEB","MAR","ABR","MAY","JUN", "JUL","AGO","SEP","OCT","NOV"] %>

<body>
  <%- include("../partials/navigation/navigation-bar.ejs")  %>

  <main class="main__container">

    <div class="buscador__container">
      <form action="deuda_credito">
        <i class="fa fa-search"></i>
        <input type="text" class="buscador" name="CREDITO" value="" placeholder="Buscar ficha" />
        <input type="hidden" name="N_OPERACION" value="<%= N_OPERACION  %>">
        <input type="hidden" name="TITULAR" value="<%= TITULAR  %>">
      </form>

      <form action="deuda_cte">
        <i class="fa fa-search"></i>
        <input type="text" class="buscador" name="CTE" value="" placeholder="Buscar cliente" />
        <input type="hidden" name="N_OPERACION" value="<%= N_OPERACION  %>">
        <input type="hidden" name="TITULAR" value="<%= TITULAR  %>">
      </form>
    </div>

    <header class="creditos__header">
      <h1 class="CTE_NOMBRE"><%= cte_data.CALLE  %></h1>
      <div class="CTE_CALLE">
        <a href="/CRM?CTE=<%= cte_data.CTE %>" class="CTE link"><%= cte_data.CTE %></a>
        <span class="CALLE"><%=cte_data.NOMBRE %></span>
        <span class="zona"><%= cte_data.ZONA %></span>
      </div>

      <div>
        <div>Tel:<%= cte_data.WHATSAPP || "Sin telefono"%></div>
      </div>
    </header>

    <% prestamos.forEach(prestamo => { %>
    <%- include("../partials/Components/credito.prestamo.ejs",{prestamo, N_OPERACION, TITULAR}) %>
    <% }) %>

    <% fichas.forEach(ficha => { %>
    <% const {vencimiento_vigente,cuota,servicio,mora,atraso,pagas,vencidas,EsPrimerPago} = ficha.deuda %>
    <% const {CUOTA,PRIMER_PAGO,SALDO,FICHA,CTE,Z,FECHA_VENTA,VENCIMIENTO,ARTICULOS,CUOTAS,TOTAL,SERV_UNIT} = ficha.data %>
    <form class="credito" method="POST" action="cargar_pago">
      <div class="credito__header">
        <span>
          <i class="fas fa-exclamation-circle btn-detalles"></i> Credito: <%= FICHA %>
        </span>
        <span class="<%= vencimiento_vigente < getToday() ? "vencimiento_atrasado" : "vencimiento_al-dia" %>"><%= vencimiento_vigente %></span>
      </div>
      <div class="details">
        <% if(EsPrimerPago) {%>
        <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Primer Ven", data : PRIMER_PAGO || "primer pago"}) %>
        <% } %>
        <%- include(`${global.dir_partials}/pagos/detail_row.important.ejs`,{title : "Total a cobrar", data : (cuota || Math.min(CUOTA,SALDO)) + servicio + mora }) %>
        <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Cuota", data : cuota}) %>
        <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Serv", data : servicio}) %>
        <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Mora", data : mora}) %>
        <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Atrasos", data : atraso}) %>
        <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Pagas", data : pagas}) %>
        <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Vencidas", data : vencidas}) %>
        <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Valor cuota", data : CUOTA}) %>
        <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Saldo actual", data : SALDO}) %>

        <div class="input__container">


          <% if(user.RANGO == "COBRADOR" || user.RANGO == "VENDEDOR") {%>
          <input type="number" name="DECLARADO_CUO" placeholder="Cuota Cobrado" required />
          <input type="number" name="DECLARADO_COB" placeholder="Cobrador" required />
          <% } else { %>
          <input type="number" name="COBRADO" placeholder="Monto cobrado" required />
          <% } %>

          <div class="input__container_input">
            <span>COB:</span>
            <input type="date" name="FECHA_COB" min="<%= getToday() %>" max="<%= new Date(new Date().getTime()+ 1000*60*60*24*50).toISOString().split("T")[0]%>">
          </div>
          <input type="text" name="OBS" placeholder="Observacion" />


          <% if(N_OPERACION && TITULAR){ %>
          <input type="number" name="MP_PORCENTAJE" placeholder="Recargo por MP" required />
          <input type="number" placeholder="Numero de operacion" name="N_OPERACION" value="<%= N_OPERACION %>" minlength="6" />

          <select name="MP_TITULAR">
            <% usuarios.forEach(usuario => {%>
            <option value="<%= usuario.Usuario %>" <%= usuario.Usuario == TITULAR ? "selected" : "" %>> <%= usuario.Usuario %></option>
            <% }); %>
          </select>

          <input type="checkbox" name="ISMP" hidden checked="<%= !!(N_OPERACION && TITULAR) %>" />
          <% } %>

          <input type="hidden" name="CTE" value="<%= CTE %>">
          <input type="hidden" name="FICHA" value="<%= FICHA %>">
          <input type="hidden" name="ZONA" value="<%= Z %>">
          <input type="hidden" name="EsRecorrido" value="<%= EsRecorrido %>">

        </div>

      </div>

      <div class="btn__container">
        <input type="submit" class="btn btn-cargar-pago" value="Cobrar" formaction="cargar_pago"></input>
        <input type="submit" class="btn btn-cambiar-fecha" value="Cambio de fecha" formaction="/cobrador/cambiarFecha"></input>
        <a class="btn btn-cambiar-fecha link" href="/cobrador/volver?<%=`ZONA=${Z}&FICHA=${FICHA}`%>">Mover al final</a>
        <% if(EsRecorrido == 'true'){%>
        <a class="btn btn-cambiar-fecha link" href="<%=`/cobrador/recorrido/${Z}`%>">Ver recorrido</a>
        <% } %>
      </div>

      <div class="deep_details show">
        <div class="header">
          <h3>Credito : <%= FICHA %></h3> <span><i class="fas fa-times btn-cerrar-detalle"></i></span>
        </div>
        <div class="details">

          <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Fecha de venta", data : FECHA_VENTA}) %>
          <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Vencimiento", data : VENCIMIENTO}) %>
          <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Cuota", data : ficha.deuda.cuota}) %>
          <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Servicio", data : ficha.deuda.servicio}) %>
          <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Mora", data : ficha.deuda.mora}) %>
          <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Atraso", data : ficha.deuda.atraso}) %>
          <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Pagas", data : ficha.deuda.pagas}) %>
          <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Articulos", data : ficha.articulos_string}) %>
          <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Cant cuotas", data : CUOTAS}) %>
          <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Cuota", data : CUOTA}) %>
          <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "Total", data : TOTAL}) %>
          <%- include(`${global.dir_partials}/pagos/detail_row.ejs`,{title : "ServicioUnitario", data : SERV_UNIT}) %>


          <!-- TABLA DE MESES -->
          <div class="table">
            <table>
              <thead>
                <th>Mes</th>
                <th>Cuota</th>
                <th>Cobrador</th>
              </thead>
              <tbody>
                <% for(let i = 0;i< ficha.acumulado.length;i++) {%>
                <tr>
                  <td><%= meses[ficha.acumulado[i].MES] %></td>
                  <td><%= ficha.acumulado[i].CUOTA %></td>
                  <td><%= ficha.acumulado[i].MORA + ficha.acumulado[i].SERV %></td>
                </tr>
                <% } %>

              </tbody>
            </table>
          </div>
          <!-- QUERY AGRUPADA POR MESES -->

        </div>



      </div>

    </form>

    <% }); %>





  </main>
  <%- include("../partials/links/nav.logic.ejs") %>
  <script src="/pagos/js/form_validation.js"></script>
  <script src="/pagos/js/button_events.js"></script>
</body>

</html>